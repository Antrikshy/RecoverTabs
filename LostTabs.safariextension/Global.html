<!DOCTYPE HTML>
<html>
<head>

<script type='text/javascript'>

var closedTabURLs = [];

safari.application.addEventListener("close", function (e) {
    if (e.target instanceof SafariBrowserTab)
        closedTabURLs.push(e.target.url);
}, true);

safari.application.addEventListener('message', handleMessage, false);

function handleMessage(msg) {
    if (msg.name == 'reopenTab') {
        reopenClosedTabs();
    }
}

var reopenClosedTabs = function(){
    var active = safari.application.activeBrowserWindow.activeTab;
    var tabs = safari.application.activeBrowserWindow.tabs;

    // var index = 0;
    for (var index = 0; index < tabs.length; index++) {
        if (tabs[index] == active)
            break;
    }

    if (closedTabURLs.length > 0) {
        var reopenURL = closedTabURLs.pop();
        var newTab = safari.application.activeBrowserWindow.openTab('foreground', index + 1);
        newTab.url = reopenURL;
    }
}

</script>

</head>
</html>